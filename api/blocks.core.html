<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>blocks.core documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Blocks</span> <span class="project-version">2.0.0</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="store.html"><div class="inner"><span># Implementation Decisions</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>blocks</span></div></div></li><li class="depth-2 branch current"><a href="blocks.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-2 branch"><a href="blocks.meter.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>meter</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>store</span></div></div></li><li class="depth-3 branch"><a href="blocks.store.buffer.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>buffer</span></div></a></li><li class="depth-3 branch"><a href="blocks.store.cache.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>cache</span></div></a></li><li class="depth-3 branch"><a href="blocks.store.file.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>file</span></div></a></li><li class="depth-3 branch"><a href="blocks.store.memory.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>memory</span></div></a></li><li class="depth-3"><a href="blocks.store.replica.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>replica</span></div></a></li><li class="depth-2"><a href="blocks.summary.html"><div class="inner"><span class="tree" style="top: -176px;"><span class="top" style="height: 185px;"></span><span class="bottom"></span></span><span>summary</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="blocks.core.html#var--.3Estore"><div class="inner"><span>-&gt;store</span></div></a></li><li class="depth-1"><a href="blocks.core.html#var-default-algorithm"><div class="inner"><span>default-algorithm</span></div></a></li><li class="depth-1"><a href="blocks.core.html#var-delete.21"><div class="inner"><span>delete!</span></div></a></li><li class="depth-1"><a href="blocks.core.html#var-delete-batch.21"><div class="inner"><span>delete-batch!</span></div></a></li><li class="depth-1"><a href="blocks.core.html#var-erase.21"><div class="inner"><span>erase!</span></div></a></li><li class="depth-1"><a href="blocks.core.html#var-from-file"><div class="inner"><span>from-file</span></div></a></li><li class="depth-1"><a href="blocks.core.html#var-get"><div class="inner"><span>get</span></div></a></li><li class="depth-1"><a href="blocks.core.html#var-get-batch"><div class="inner"><span>get-batch</span></div></a></li><li class="depth-1"><a href="blocks.core.html#var-lazy.3F"><div class="inner"><span>lazy?</span></div></a></li><li class="depth-1"><a href="blocks.core.html#var-list"><div class="inner"><span>list</span></div></a></li><li class="depth-1"><a href="blocks.core.html#var-list-seq"><div class="inner"><span>list-seq</span></div></a></li><li class="depth-1"><a href="blocks.core.html#var-load.21"><div class="inner"><span>load!</span></div></a></li><li class="depth-1"><a href="blocks.core.html#var-loaded.3F"><div class="inner"><span>loaded?</span></div></a></li><li class="depth-1"><a href="blocks.core.html#var-open"><div class="inner"><span>open</span></div></a></li><li class="depth-1"><a href="blocks.core.html#var-put.21"><div class="inner"><span>put!</span></div></a></li><li class="depth-1"><a href="blocks.core.html#var-put-batch.21"><div class="inner"><span>put-batch!</span></div></a></li><li class="depth-1"><a href="blocks.core.html#var-read.21"><div class="inner"><span>read!</span></div></a></li><li class="depth-1"><a href="blocks.core.html#var-scan"><div class="inner"><span>scan</span></div></a></li><li class="depth-1"><a href="blocks.core.html#var-stat"><div class="inner"><span>stat</span></div></a></li><li class="depth-1"><a href="blocks.core.html#var-store.21"><div class="inner"><span>store!</span></div></a></li><li class="depth-1"><a href="blocks.core.html#var-sync.21"><div class="inner"><span>sync!</span></div></a></li><li class="depth-1"><a href="blocks.core.html#var-validate.21"><div class="inner"><span>validate!</span></div></a></li><li class="depth-1"><a href="blocks.core.html#var-write.21"><div class="inner"><span>write!</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">blocks.core</h1><div class="doc"><div class="markdown"><p>Core block storage API.</p>
<p>Functions which may cause side effects or IO are marked with bangs - for example <code>(read! "foo")</code> doesnâ€™t have side-effects, but <code>(read!  some-input-stream)</code> will consume bytes from the stream.</p></div></div><div class="public anchor" id="var--.3Estore"><h3>-&gt;store</h3><div class="usage"><code>(-&gt;store uri)</code></div><div class="doc"><div class="markdown"><p>Constructs a new block store from a URI by dispatching on the scheme. The store will be returned in an initialized (but not started) state.</p></div></div><div class="src-link"><a href="https://github.com/greglook/blocks/blob/master/src/blocks/core.clj#L195">view source</a></div></div><div class="public anchor" id="var-default-algorithm"><h3>default-algorithm</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>The hashing algorithm used if not specified in functions which create blocks.</p></div></div><div class="src-link"><a href="https://github.com/greglook/blocks/blob/master/src/blocks/core.clj#L34">view source</a></div></div><div class="public anchor" id="var-delete.21"><h3>delete!</h3><div class="usage"><code>(delete! store id)</code></div><div class="doc"><div class="markdown"><p>Remove a block from the store. Returns a deferred which yields true if the block was found and removed.</p></div></div><div class="src-link"><a href="https://github.com/greglook/blocks/blob/master/src/blocks/core.clj#L384">view source</a></div></div><div class="public anchor" id="var-delete-batch.21"><h3>delete-batch!</h3><div class="usage"><code>(delete-batch! store ids)</code></div><div class="doc"><div class="markdown"><p>Remove a batch of blocks from the store, identified by a collection of multihashes. Returns a deferred which yields a set of ids for the blocks which were found and deleted.</p>
<p>This is not guaranteed to be atomic; readers may see the store in a partially deleted state.</p></div></div><div class="src-link"><a href="https://github.com/greglook/blocks/blob/master/src/blocks/core.clj#L428">view source</a></div></div><div class="public anchor" id="var-erase.21"><h3>erase!</h3><div class="usage"><code>(erase! store)</code></div><div class="doc"><div class="markdown"><p>Completely remove all data associated with the store. After this call, the store will be empty. Returns a deferred which yields true once the store has been erased.</p>
<p>This is not guaranteed to be atomic; readers may see the store in a partially erased state.</p></div></div><div class="src-link"><a href="https://github.com/greglook/blocks/blob/master/src/blocks/core.clj#L471">view source</a></div></div><div class="public anchor" id="var-from-file"><h3>from-file</h3><div class="usage"><code>(from-file file)</code><code>(from-file file algorithm)</code></div><div class="doc"><div class="markdown"><p>Create a lazy block from a local file. Returns the block, or nil if the file does not exist or is empty.</p>
<p>The file is read once to calculate the identifier.</p></div></div><div class="src-link"><a href="https://github.com/greglook/blocks/blob/master/src/blocks/core.clj#L78">view source</a></div></div><div class="public anchor" id="var-get"><h3>get</h3><div class="usage"><code>(get store id)</code></div><div class="doc"><div class="markdown"><p>Load a block from the store. Returns a deferred which yields the block if the store contains it, or nil if no block is stored for that id.</p></div></div><div class="src-link"><a href="https://github.com/greglook/blocks/blob/master/src/blocks/core.clj#L321">view source</a></div></div><div class="public anchor" id="var-get-batch"><h3>get-batch</h3><div class="usage"><code>(get-batch store ids)</code></div><div class="doc"><div class="markdown"><p>Retrieve a batch of blocks identified by a collection of multihashes. Returns a deferred which yields a collection of the blocks which were found.</p>
<p>The blocks are returned in no particular order, and any missing blocks are omitted from the result.</p></div></div><div class="src-link"><a href="https://github.com/greglook/blocks/blob/master/src/blocks/core.clj#L400">view source</a></div></div><div class="public anchor" id="var-lazy.3F"><h3>lazy?</h3><div class="usage"><code>(lazy? block)</code></div><div class="doc"><div class="markdown"><p>True if the given block reads its content on-demand.</p></div></div><div class="src-link"><a href="https://github.com/greglook/blocks/blob/master/src/blocks/core.clj#L72">view source</a></div></div><div class="public anchor" id="var-list"><h3>list</h3><div class="usage"><code>(list store &amp; opts)</code></div><div class="doc"><div class="markdown"><p>Enumerate the stored blocks, returning a stream of blocks ordered by their multihash id. The store will continue listing blocks until the stream is closed or there are no more matching blocks to return.</p>
<ul>
  <li><code>:algorithm</code>  Only return blocks identified by this hash algorithm.</li>
  <li><code>:after</code>  Return blocks whose id (in hex) lexically follows this string. A multihash  may also be provided and will be coerced to hex.</li>
  <li><code>:before</code>  Return blocks whose id (in hex) lexically precedes this string. A multihash  may also be provided and will be coerced to hex.</li>
  <li><code>:limit</code>  Restrict the maximum number of blocks returned on the stream.</li>
</ul></div></div><div class="src-link"><a href="https://github.com/greglook/blocks/blob/master/src/blocks/core.clj#L202">view source</a></div></div><div class="public anchor" id="var-list-seq"><h3>list-seq</h3><div class="usage"><code>(list-seq store &amp; opts)</code></div><div class="doc"><div class="markdown"><p>Enumerate the stored blocks, returning a sequence of blocks ordered by their multihash id. This wraps the <code>list</code> method and consumes the stream lazily, terminating when the stream is drained, a timeout is encountered, or a list exception is observed on the stream.</p>
<p>Accepts the same options as <code>list</code>, plus:</p>
<ul>
  <li><code>:timeout</code>  Millisecond duration to wait for new blocks to arrive on the stream.  (default: 10000)</li>
</ul></div></div><div class="src-link"><a href="https://github.com/greglook/blocks/blob/master/src/blocks/core.clj#L269">view source</a></div></div><div class="public anchor" id="var-load.21"><h3>load!</h3><div class="usage"><code>(load! block)</code></div><div class="doc"><div class="markdown"><p>Ensure the blockâ€™s content is loaded into memory. Returns a loaded version of the given block.</p>
<p>If the block is lazy, the stream is read into memory and returned as a new block. If the block is already loaded, it is returned unchanged. The returned block will have the same metadata as the one given.</p></div></div><div class="src-link"><a href="https://github.com/greglook/blocks/blob/master/src/blocks/core.clj#L143">view source</a></div></div><div class="public anchor" id="var-loaded.3F"><h3>loaded?</h3><div class="usage"><code>(loaded? block)</code></div><div class="doc"><div class="markdown"><p>True if the blockâ€™s content is already loaded into memory.</p></div></div><div class="src-link"><a href="https://github.com/greglook/blocks/blob/master/src/blocks/core.clj#L66">view source</a></div></div><div class="public anchor" id="var-open"><h3>open</h3><div class="usage"><code>(open block)</code><code>(open block opts)</code></div><div class="doc"><div class="markdown"><p>Open an input stream to read the contents of the block.</p>
<p>If <code>:start</code> and <code>:end</code> are given, the input stream will only return content from the starting index byte to the byte before the end index. For example, opening a block with size <em>n</em> with <code>(open block {:start 0, :end n})</code> would return the full block contents.</p></div></div><div class="src-link"><a href="https://github.com/greglook/blocks/blob/master/src/blocks/core.clj#L97">view source</a></div></div><div class="public anchor" id="var-put.21"><h3>put!</h3><div class="usage"><code>(put! store block)</code></div><div class="doc"><div class="markdown"><p>Save a block into the store. Returns a deferred which yields the stored block, which may have already been present in the store.</p></div></div><div class="src-link"><a href="https://github.com/greglook/blocks/blob/master/src/blocks/core.clj#L342">view source</a></div></div><div class="public anchor" id="var-put-batch.21"><h3>put-batch!</h3><div class="usage"><code>(put-batch! store blocks)</code></div><div class="doc"><div class="markdown"><p>Save a collection of blocks into the store. Returns a deferred which yields a collection of stored blocks.</p>
<p>This is not guaranteed to be atomic; readers may see the store in a partially updated state.</p></div></div><div class="src-link"><a href="https://github.com/greglook/blocks/blob/master/src/blocks/core.clj#L416">view source</a></div></div><div class="public anchor" id="var-read.21"><h3>read!</h3><div class="usage"><code>(read! source)</code><code>(read! source algorithm)</code></div><div class="doc"><div class="markdown"><p>Read data into memory from the given source and hash it to identify the block.</p></div></div><div class="src-link"><a href="https://github.com/greglook/blocks/blob/master/src/blocks/core.clj#L127">view source</a></div></div><div class="public anchor" id="var-scan"><h3>scan</h3><div class="usage"><code>(scan store &amp; opts)</code></div><div class="doc"><div class="markdown"><p>Scan blocks in the store, building up a summary. Returns a deferred which yields the summary map when the scan is complete.</p>
<p>Accepts the same arguments as <code>list</code>, plus:</p>
<ul>
  <li><code>:filter</code>  A predicate function which will be used to filter blocks listed by the  store. By default, all blocks are included.</li>
</ul></div></div><div class="src-link"><a href="https://github.com/greglook/blocks/blob/master/src/blocks/core.clj#L452">view source</a></div></div><div class="public anchor" id="var-stat"><h3>stat</h3><div class="usage"><code>(stat store id)</code></div><div class="doc"><div class="markdown"><p>Load metadata about a block if the store contains it. Returns a deferred which yields a map with block information but no content, or nil if the store does not contain the identified block.</p>
<p>The block stats include the <code>:id</code>, <code>:size</code>, and <code>:stored-at</code> fields. The returned map may also have additional implementation-specific storage metadata, similar to returned blocks.</p></div></div><div class="src-link"><a href="https://github.com/greglook/blocks/blob/master/src/blocks/core.clj#L303">view source</a></div></div><div class="public anchor" id="var-store.21"><h3>store!</h3><div class="usage"><code>(store! store source)</code><code>(store! store source algorithm)</code></div><div class="doc"><div class="markdown"><p>Store content from a byte source in a block store. Returns a deferred which yields the stored block, or nil if the source was empty.</p>
<p>If the source is a file, it will be streamed into the store, otherwise the content is read into memory.</p></div></div><div class="src-link"><a href="https://github.com/greglook/blocks/blob/master/src/blocks/core.clj#L363">view source</a></div></div><div class="public anchor" id="var-sync.21"><h3>sync!</h3><div class="usage"><code>(sync! source dest &amp; opts)</code></div><div class="doc"><div class="markdown"><p>Synchronize blocks from the <code>source</code> store to the <code>dest</code> store. Returns a deferred which yields a summary of the copied blocks. Options may include:</p>
<ul>
  <li><code>:filter</code>  A function to run on every block before it is synchronized. The block will  only be copied if the filter returns a truthy value.</li>
</ul></div></div><div class="src-link"><a href="https://github.com/greglook/blocks/blob/master/src/blocks/core.clj#L494">view source</a></div></div><div class="public anchor" id="var-validate.21"><h3>validate!</h3><div class="usage"><code>(validate! block)</code></div><div class="doc"><div class="markdown"><p>Check a block to verify that it has the correct identifier and size for its content. Returns true if the block is valid, or throws an exception on any error.</p></div></div><div class="src-link"><a href="https://github.com/greglook/blocks/blob/master/src/blocks/core.clj#L161">view source</a></div></div><div class="public anchor" id="var-write.21"><h3>write!</h3><div class="usage"><code>(write! block out)</code></div><div class="doc"><div class="markdown"><p>Write a blockâ€™s content to an output stream.</p></div></div><div class="src-link"><a href="https://github.com/greglook/blocks/blob/master/src/blocks/core.clj#L136">view source</a></div></div></div></body></html>